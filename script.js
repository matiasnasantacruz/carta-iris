// ===== CHAPTER DATA =====
const CHAPTERS = [
    {
        id: 1,
        title: "1 - Los inicios",
        body: `Yo ya te conocía de antes... siempre hablaban de vos como una persona con mucha proyección ✨ muy hábil y que eras un bochooo.
*Ya desde ahí quería conocerte en persona.*

Un buen día... 📲 me mandaste un par de solicitudes y ya de ahí nos empezamos a seguir en redes. Aunque todavía no hablábamos nada . Habíamos tenido antes un contacto por el tema de armar currículums.
Hasta queeeeee... ¡Diste el primer paso! 😏 (Muy valiente de tu parte je)
Yo tenía una resacaaa y vos me habías preguntado si no estaba enfermo o algo jajajaja. Esa noche hablamos hasta las 2 am ⏰ (!!!!) (domingo para lunes encima, yo al otro día laburaba vo sabe lo que e). Pero no me importó porque **ME ENCANTABA**.

Ya me habías atrapado desde ahí. Y después tuvimos nuestra primera cita (UN DÍA DE MUCHÍSIMO FRÍO SEGURAMENTE TE ACORDÁS, no fue el mejor día para salir a caminar). La pura y honesta verdad: no teníamos mucho en común 🤷‍♂️. Yo hablaba un montón y vos casi nada... solo te reías con esa sonrisa ANGELICAL 🙈.
Pero ya ahí vi que eras hermosa 😍 y *completamente diferente*, con un aire de dulzura que sinceramente atrapó tanto mi curiosidad como mi atención 💖.

Nos vimos un par de veces más. Yo te llevaba a la escuela cositas para la merienda 🍪, y hasta mate ☕ (me robaste el termo Lazzarini). Detalles simples... pero llenos de ganas de cuidarte y de decirte que yo estaba ahí para vos.

Y entooooonces... llega ese sábado 24 de agosto (OSEA HACE UN AÑO). Vos querías cocinar ñoquis 🍝 y me dijiste que los ibas a hacer en casa. Yo conseguí todo (hasta me compré una olla).
Estuviste hasta tarde cocinando, dale que dale, ¡y terminamos comiendo a la 1 de la mañana! 😂

Esa noche... después de los ñoquis...
🔥 **tuvimos EL momento de PASIÓN** 🔥 (osea relaciones sensuales jajajaja)

Y en medio de todo el acto... nos miramos... y sin pensarlo demasiado...
💍 **NOS OFICIALIZAMOS COMO PAREJA.**
Inesperado. Loco. Raro. ESPONTÁNEO.
Pero absolutamente **perfecto** 🥰. Como tenía que ser.`
    },
    {
        id: 2,
        title: "2 - La tormenta",
        body: `Al poco de empezar a salir, nos tocó atravesar una **tormenta** 🌧️ que puso todo a prueba. Fue un momento cargado de dudas, de miedos, de heridas viejas que volvieron a abrirse. Ahí entendí lo difícil que había sido para vos confiar, lo mucho que habías cargado en silencio 💔.

*Yo no sabía cómo iba a terminar todo.*
Lo más fácil hubiera sido alejarme, decir "hasta acá llegué"... pero dentro mío había algo más fuerte: **la fe en vos, en tu fuerza, tu resiliencia, y en todo lo que podías lograr**. Y por eso decidí quedarme. ⚡

**Me prometí NO ABANDONARTE en tu momento más difícil.**
Preferí ser tu refugio (aunque no siempre supiera cómo hacerlo bien). Te acompañé como pude: con mis palabras, con mis gestos, con mi presencia, con algunos mates o simplemente yéndote a buscar para dormir juntos aún si no había mucho más que hacer.

Esos meses fueron duros... hubo momentos en que sentimos que todo podía terminar.
<span class="faded">Las discusiones, las diferencias, las dudas pesaban mucho...</span>
Pero aun así, vos seguías ahí conmigo (ya sea porque sí, o para tener contención, o tal vez sí realmente había algo que te unía conmigo) y yo seguía queriéndote y apostando al 1000000% por vos 💙.

No teníamos taaaantas cosas en común, no éramos una pareja de película 🎬 en esos inicios al menos...
pero había algo mucho más real: un vínculo que, aunque frágil, seguía sosteniéndonos.

Me enorgullece haberme quedado 🌈.
Porque elegí la versión más difícil posible de la relación, sí... pero también la más verdadera: quedarme con vos y apostar por vos cuando creí que más lo necesitabas.`
    },
    {
        id: 3,
        title: "3 - El año nuevo",
        body: `Arrancó el 2025 y sentí cómo empezó a cambiar y madurar nuestra relación. Te fuiste soltando, empezaste a acompañarme a las juntadas, y **pasamos mucho (bastante) más tiempo juntos** 🌞✨.
Sentí que, de a poco y sin apuro, empezabamos a estar en la misma sintonía.

Y... luego llegó febrero: nuestros cumpleaños que están tan cerquita uno del otro 🎂🎉.
Fueron días y noches pagajosos (jajajaja), con risas, pelis, sanguchitos, mates... y un nosotros que crecía 💞.

Hacía por entonces <span class="heat-shimmer">MUCHÍSIMO CALOR</span> 🥵🪭, peeero igual **dormíamos abrazados** y **hacíamos el amor** como que si no importara demasiado... Ya si teníamos relaciones ahí era porque mínimo nos gustábamos muchísimo jajajajaja.
Entre el aire acondicionado haciendo lo que podía y nuestras noches juntos, apareció una especie de complicidad nueva entre nosotros.

Empezamos a salir más: paseos simples, mates, caminatas cortas al atardecer.
No hacía falta nada muy espectacular ni extraño, porque lo espectacular era sentir que **nos elegíamos** una y otra vez 💫.

Pero todavía faltaba una *cosita* para terminar de empujar la relación...
Yo ya veía claro que estábamos creciendo, encontrando nuestra sintonía, afinando lo nuestro.

Para entonces llevábamos unos seis meses y yo te veía brillar un poco más cada día.
Era simple: **vos y yo, EMPEZANDO A ANDAR hacia adelante**.`
    },
    {
        id: 4,
        title: "4 - Prueba de convivencia",
        body: `Y bueno, pasó otra situación difícil... justo cuando yo estaba de vacaciones. Ese último día en **Paraná** sentí bastante claro lo que tenía que hacer, que era volver y decirte **"a esto lo RESOLVEMOS juntos"**.
Te ofrecí quedarte conmigo unos días (si querías), hasta que todo se acomodara. 🏡

Eran mis últimos días de descanso y vos ya ibas a arrancar a cursar. Así que los **aprovechamos para convivir**: sin planes muy raros, solo el día a día, **vos y yo <span class="underline-wavy pulse-soft">juntos</span>** probando qué onda jajajaja.

Ahí sí que todo cambió. La casa se volvió **nuestro lugarcito**: mates compartidos 🧉, caminatas cortas al atardecer 🚶‍♂️🚶‍♀️, charlas largas, siestas cómplices.
Y bueno también hubo lugar para el desarreglo vo sabe lo que e **pizzas 🍕, helado 🍨 y hamburguesas 🍔** (nuestro "menú oficial" de vida de casados).

Entre risas y detalles simples, entendimos algo esencial: **nos gustábamos, nos DESEÁBAMOS, nos caíamos bien... y nos queríamos muuucho**.
No era solo acompañarnos en lo difícil: **era compartir**.

**<span class="underline-wavy pulse-soft">funcionamos</span>**.
Nos mirábamos y sabíamos que **<span class="underline-wavy pulse-soft">funcionamos</span>**.

Desde esos días, nuestra relación fue **otra cosa**. Más fuerte. Más clara. Más sana.
Ese pequeño ensayo de convivencia nos selló de una forma dulce y contundente.
Yo lo sentí así: **vos y yo, siendo equipo**. Siendo uno y lográndolo con muy buenos resultados 💞✨.`
    },
    {
        id: 5,
        title: "5 - Evolución",
        body: `Después de todo esto, te vi <span class="rise-soft">despegar</span> 🌟.
En lo profesional te abriste paso con tu TALENTO, tu inteligencia y tu empuje y buena voluntad que le pones a las cosas. Cada contacto nuevo, cada proyecto, cada oportunidad ES una confirmación de lo increíble que sos.
Yo a día de hoy te miro y me siento tu **fan número uno** <span class="fan-badge">🏅</span> que ya te lo dicho.

Pero no fue solo lo profesional. En lo personal floreciste: te cuidaste, te diste tu lugar, tu espacio, te volviste más libre y más segura (aunque a veces dudes de vos!).
Tu sonrisa más firme, tu mirada más clara, tu cuerpo más fuerte (esto a mi me viene de diez), tu espíritu más pleno. Verte crecer me llena de alegría y me hace muy feliz.

Y si ya eras linda... ahora sos directamente la mujer más hermosa de la tierra, la más bella.
Todos lo notan hoy y quieren estar cerca tuyo, desarrollaste un magnetismo especial.
Yo tengo el ENORME privilegio de que me elijas cada día. Y mientras creces y te hacés cada día mejor, mi pecho late de admiración <span class="gold-glow">💖</span>.

No me enamoro solo de tu gran belleza; me enamora tu fuerza, tu capacidad, tu constancia, y que NUNCA te rendiste. No puedo no amarte si sos así.
Cada logro tuyo lo vivo como si fuera mío: con orgullo, con gratitud y amor. ✨`
    },
    {
        id: 6,
        title: "6 - Nosotros hoy",
        body: `Hoy mirando hacia atrás, lo siento claro y tranquilo:
<span class="heart-beat-once ink-script">Te amo muchísimo</span> 💞. Y estoy muy enamorado de vos.

Amo cómo me buscás, cómo me cuidás, cómo me extrañas, me pensás y elegís todos los días.
Amo nuestras charlas del día, nuestras peleas, las jodas, nuestras risas 😂 que nos dejan sin aire, y nuestros silencios cómodos 🤫 que solo existen cuando hay verdad y miradas de amor.

Amo nuestra pasión 🔥: lo fácil que nos encontramos, lo bien que nos entendemos, lo mucho que nos deseamos.
Me siento <strong>orgulloso de nosotros</strong>. No tuvimos el camino fácil ni perfecto; tuvimos el camino real.
Elegimos apostar incluso cuando costaba... y valió la pena.

Hoy somos esto: dos personas que se eligen, que se cuidan y que siguen construyendo.
<span class="breath ink-script">Nuestra casa es donde estamos juntos.</span>`
    },
    {
        id: 7,
        title: "7 - Lo que viene",
        body: `Gracias por ser vos, Iris.
Gracias por elegirme.
Gracias por dejarme ser tu compañero y tu refugio, por confiar en mí.

Sos mi bombón precioso 🍫, mi nenita chiquita linda 🐥, mi orgullo, mi amor, MI MUJER.
Este primer año fue intenso y hermoso: nos probó, nos enseñó y nos hizo crecer. Lo volvería a transitar y elegir mil veces más.

Si todo esto fue solo el comienzo...
<span class="shine-soft">sé que lo que se viene será aún mejor, más prometedor</span> ✨.

Sueño con lo que vamos a construir: crecer juntos, mates relajados, pelis, tardes de tortas fritas ojalá, noches de abrazos, una relación con risas y paz 🏡✈️.
Voy a seguir eligiéndote una y otra vez, y más en los momentos donde sea más difícil.

<strong>Te amo con todo lo que soy</strong>.
De la forma más sincera que se puede amar, con mi cuerpo, con mi mente, con mi corazón 💖.

Feliz primer aniversario gran amor mío. Te amo. 🌹

Matías Santa Cruz.`
    }
];

// ===== APPLICATION STATE =====
class LoveStoryApp {
    constructor() {
        this.currentChapter = 1;
        this.isTypewriting = false;
        this.typewriterTimeout = null;
        this.settings = {
            typewriterEnabled: true,
            soundEnabled: false,
            theme: 'light' // 'auto', 'light', 'dark'
        };
        this.audioContext = null;
        this.heartPool = [];
        
        this.init();
    }

    // ===== INITIALIZATION =====
    init() {
        this.loadState();
        this.setupEventListeners();
        this.initTheme();
        this.renderChapter(this.currentChapter);
        this.updateProgress();
        this.initAudio();
    }

    // ===== STATE MANAGEMENT =====
    loadState() {
        try {
            const saved = localStorage.getItem('loveStory_state');
            if (saved) {
                const state = JSON.parse(saved);
                this.currentChapter = Math.max(1, Math.min(7, state.currentChapter || 1));
                this.settings = { ...this.settings, ...state.settings };
            }
        } catch (error) {
            console.warn('Could not load saved state:', error);
        }
    }

    saveState() {
        try {
            const state = {
                currentChapter: this.currentChapter,
                settings: this.settings
            };
            localStorage.setItem('loveStory_state', JSON.stringify(state));
        } catch (error) {
            console.warn('Could not save state:', error);
        }
    }

    // ===== EVENT LISTENERS =====
    setupEventListeners() {
        // Navigation buttons
        document.getElementById('prev-btn').addEventListener('click', () => this.goToPreviousChapter());
        document.getElementById('next-btn').addEventListener('click', () => this.goToNextChapter());
        
        // Progress dots
        document.querySelectorAll('.progress-dot').forEach(dot => {
            dot.addEventListener('click', (e) => {
                const chapter = parseInt(e.target.dataset.chapter);
                this.goToChapter(chapter);
            });
        });

        // Heart button
        document.getElementById('heart-btn').addEventListener('click', (e) => {
            this.spawnHearts(e.clientX, e.clientY);
        });

        // Theme toggle
        document.getElementById('theme-toggle').addEventListener('click', () => this.toggleTheme());

        // Settings modal
        document.getElementById('settings-btn').addEventListener('click', () => this.openSettings());
        document.getElementById('close-modal').addEventListener('click', () => this.closeSettings());
        document.getElementById('settings-modal').addEventListener('click', (e) => {
            if (e.target.id === 'settings-modal') this.closeSettings();
        });

        // Settings toggles
        document.getElementById('typewriter-toggle').addEventListener('click', () => this.toggleTypewriter());
        document.getElementById('sound-toggle').addEventListener('click', () => this.toggleSound());
        document.getElementById('theme-modal-toggle').addEventListener('click', () => this.toggleTheme());

        // Other controls
        document.getElementById('reset-btn').addEventListener('click', () => this.resetProgress());
        document.getElementById('skip-animation').addEventListener('click', () => this.skipTypewriter());
        document.getElementById('export-pdf').addEventListener('click', () => this.exportToPDF());
        document.getElementById('final-surprise').addEventListener('click', () => this.openSurprise());

        // Keyboard navigation
        document.addEventListener('keydown', (e) => this.handleKeyboard(e));

        // ESC key for modal
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && document.getElementById('settings-modal').classList.contains('active')) {
                this.closeSettings();
            }
        });
    }

    handleKeyboard(e) {
        // Don't interfere when modal is open
        if (document.getElementById('settings-modal').classList.contains('active')) return;

        switch (e.key) {
            case 'ArrowRight':
            case ' ':
            case 'Enter':
                e.preventDefault();
                this.goToNextChapter();
                break;
            case 'ArrowLeft':
            case 'Backspace':
                e.preventDefault();
                this.goToPreviousChapter();
                break;
            case 'Home':
                e.preventDefault();
                this.goToChapter(1);
                break;
            case 'End':
                e.preventDefault();
                this.goToChapter(7);
                break;
            case 'Escape':
                if (this.isTypewriting) {
                    this.skipTypewriter();
                }
                break;
        }
    }

    // ===== CHAPTER NAVIGATION =====
    goToChapter(chapterNumber, showConfirmation = true) {
        if (chapterNumber < 1 || chapterNumber > 7) return;
        
        // Show confirmation if jumping ahead
        if (showConfirmation && chapterNumber > this.currentChapter) {
            if (!confirm(`¿Estás segura de que querés saltar al Capítulo ${chapterNumber}? Podrías perderte parte de la historia.`)) {
                return;
            }
        }

        this.currentChapter = chapterNumber;
        this.renderChapter(chapterNumber);
        this.updateProgress();
        this.saveState();
        this.playSound();
        this.spawnHeartsRandom();
    }

    goToNextChapter() {
        if (this.currentChapter < 7) {
            this.goToChapter(this.currentChapter + 1, false);
        }
    }

    goToPreviousChapter() {
        if (this.currentChapter > 1) {
            this.goToChapter(this.currentChapter - 1, false);
        }
    }

    // ===== CLEANUP FUNCTIONS =====
    cleanupPreviousEffects() {
        // Stop typewriter if running
        if (this.isTypewriting) {
            clearTimeout(this.typewriterTimeout);
            this.isTypewriting = false;
            this.hideTypewriterControls();
        }

        // Clear all animated elements and effects
        const heartsContainer = document.getElementById('hearts-container');
        if (heartsContainer) {
            heartsContainer.innerHTML = '';
        }

        // Remove all temporary animation classes
        const mainContent = document.getElementById('main-content');
        if (mainContent) {
            mainContent.classList.remove('home-glow');
        }

        // Remove all pin-float animate classes
        document.querySelectorAll('.pin-float.animate').forEach(pin => {
            pin.classList.remove('animate');
        });

        // Remove all floating elements
        document.querySelectorAll('.floating-heart, .floating-spark').forEach(el => {
            if (el.parentNode) {
                el.parentNode.removeChild(el);
            }
        });

        // Remove any confetti or raindrops
        document.querySelectorAll('.confetti, .raindrop').forEach(el => {
            if (el.parentNode) {
                el.parentNode.removeChild(el);
            }
        });

        // Clear all chapter-specific body classes
        document.body.classList.remove('chapter-3-active', 'chapter-4-active', 'chapter-5-active', 'chapter-6-active', 'chapter-7-active');
    }

    // ===== CHAPTER RENDERING =====
    renderChapter(chapterNumber) {
        const chapter = CHAPTERS.find(c => c.id === chapterNumber);
        if (!chapter) return;

        // Stop any ongoing effects from previous chapters
        this.cleanupPreviousEffects();

        // Update title
        document.getElementById('chapter-title').textContent = chapter.title;

        // Clear content
        const contentEl = document.getElementById('chapter-content');
        contentEl.innerHTML = '';

        // Add chapter-specific class
        const mainContent = document.getElementById('main-content');
        mainContent.className = `main-content chapter-${chapterNumber}`;
        
        // Add special class for Chapter 3, 4, 5, 6, 7 effects
        if (chapterNumber === 3) {
            document.body.classList.add('chapter-3-active');
            document.body.classList.remove('chapter-4-active', 'chapter-5-active', 'chapter-6-active', 'chapter-7-active');
        } else if (chapterNumber === 4) {
            document.body.classList.add('chapter-4-active');
            document.body.classList.remove('chapter-3-active', 'chapter-5-active', 'chapter-6-active', 'chapter-7-active');
        } else if (chapterNumber === 5) {
            document.body.classList.add('chapter-5-active');
            document.body.classList.remove('chapter-3-active', 'chapter-4-active', 'chapter-6-active', 'chapter-7-active');
        } else if (chapterNumber === 6) {
            document.body.classList.add('chapter-6-active');
            document.body.classList.remove('chapter-3-active', 'chapter-4-active', 'chapter-5-active', 'chapter-7-active');
        } else if (chapterNumber === 7) {
            document.body.classList.add('chapter-7-active');
            document.body.classList.remove('chapter-3-active', 'chapter-4-active', 'chapter-5-active', 'chapter-6-active');
        } else {
            document.body.classList.remove('chapter-3-active', 'chapter-4-active', 'chapter-5-active', 'chapter-6-active', 'chapter-7-active');
        }

        // Split body into paragraphs
        const paragraphs = chapter.body.split('\n').filter(p => p.trim());

        if (this.settings.typewriterEnabled) {
            this.typewriterRender(contentEl, paragraphs, chapterNumber);
        } else {
            this.instantRender(contentEl, paragraphs, chapterNumber);
        }

        // Update navigation buttons
        document.getElementById('prev-btn').disabled = chapterNumber === 1;
        document.getElementById('next-btn').disabled = chapterNumber === 7;
        
        // Show final surprise button on chapter 7
        const finalSurpriseBtn = document.getElementById('final-surprise');
        if (chapterNumber === 7) {
            finalSurpriseBtn.style.display = 'block';
        } else {
            finalSurpriseBtn.style.display = 'none';
        }

        // Scroll to top of content
        document.getElementById('main-content').scrollIntoView({ behavior: 'smooth' });
    }

    instantRender(contentEl, paragraphs, chapterNumber) {
        paragraphs.forEach((paragraph, index) => {
            const p = document.createElement('p');
            
            if (chapterNumber === 1) {
                p.innerHTML = this.processChapter1Content(paragraph);
                
                // Add floating elements for Chapter 1
                if (index === 2) { // After the first conversation paragraph
                    const heart = document.createElement('div');
                    heart.className = 'floating-heart';
                    heart.innerHTML = '💕';
                    contentEl.appendChild(heart);
                }
                if (index === 5) { // After the ñoquis paragraph
                    const spark = document.createElement('div');
                    spark.className = 'floating-spark';
                    spark.innerHTML = '✨';
                    contentEl.appendChild(spark);
                }
            } else if (chapterNumber === 2) {
                p.innerHTML = this.processChapter2Content(paragraph);
                
                // Add raindrop elements for Chapter 2
                if (index === 1) { // After the storm paragraph
                    this.createRainDrops();
                }
            } else if (chapterNumber === 3) {
                p.innerHTML = this.processChapter3Content(paragraph);
                
                // Add birthday confetti for Chapter 3
                if (index === 1) { // After the birthday paragraph
                    this.createBirthdayConfetti();
                }
            } else if (chapterNumber === 4) {
                p.innerHTML = this.processChapter4Content(paragraph);
                
                // Add home glow effect for Chapter 4
                if (index === 0) { // First paragraph
                    this.createHomeGlow();
                }
                // Add pin float for Paraná
                if (index === 1) {
                    this.createPinFloat();
                }
            } else if (chapterNumber === 5) {
                p.innerHTML = this.processChapter5Content(paragraph);
                
                // Add golden glow effect for Chapter 5
                if (index === 0) { // First paragraph
                    this.createGoldenGlow();
                }
            } else if (chapterNumber === 6) {
                p.innerHTML = this.processChapter6Content(paragraph);
                
                // Add intimate atmosphere for Chapter 6
                if (index === 0) { // First paragraph
                    this.createIntimateAtmosphere();
                }
            } else if (chapterNumber === 7) {
                p.innerHTML = this.processChapter7Content(paragraph);
                
                // Add heart confetti at the end of Chapter 7
                if (index === paragraphs.length - 1) { // Last paragraph
                    this.createHeartConfetti();
                }
            } else {
                p.textContent = paragraph;
            }
            
            contentEl.appendChild(p);
        });
        this.hideTypewriterControls();
    }

    typewriterRender(contentEl, paragraphs, chapterNumber) {
        this.isTypewriting = true;
        this.showTypewriterControls();
        
        let paragraphIndex = 0;
        let charIndex = 0;
        let currentP = null;

        const typeNextChar = () => {
            if (paragraphIndex >= paragraphs.length) {
                this.isTypewriting = false;
                this.hideTypewriterControls();
                return;
            }

            if (charIndex === 0) {
                currentP = document.createElement('p');
                contentEl.appendChild(currentP);
                
                // Add floating elements for Chapter 1 during typewriter
                if (chapterNumber === 1) {
                    if (paragraphIndex === 2) {
                        const heart = document.createElement('div');
                        heart.className = 'floating-heart';
                        heart.innerHTML = '💕';
                        contentEl.appendChild(heart);
                    }
                    if (paragraphIndex === 5) {
                        const spark = document.createElement('div');
                        spark.className = 'floating-spark';
                        spark.innerHTML = '✨';
                        contentEl.appendChild(spark);
                    }
                }
            }

            const currentParagraph = paragraphs[paragraphIndex];
            
            if (chapterNumber === 1) {
                // For Chapter 1, we need to handle HTML content
                const processedContent = this.processChapter1Content(currentParagraph.slice(0, charIndex + 1));
                currentP.innerHTML = processedContent;
            } else if (chapterNumber === 2) {
                // For Chapter 2, we need to handle HTML content
                const processedContent = this.processChapter2Content(currentParagraph.slice(0, charIndex + 1));
                currentP.innerHTML = processedContent;
                
                // Add rain drops when we reach the storm paragraph
                if (paragraphIndex === 1 && charIndex === currentParagraph.length - 1) {
                    this.createRainDrops();
                }
            } else if (chapterNumber === 3) {
                // For Chapter 3, we need to handle HTML content
                const processedContent = this.processChapter3Content(currentParagraph.slice(0, charIndex + 1));
                currentP.innerHTML = processedContent;
                
                // Add birthday confetti when we reach the birthday paragraph
                if (paragraphIndex === 1 && charIndex === currentParagraph.length - 1) {
                    this.createBirthdayConfetti();
                }
            } else if (chapterNumber === 4) {
                // For Chapter 4, we need to handle HTML content
                const processedContent = this.processChapter4Content(currentParagraph.slice(0, charIndex + 1));
                currentP.innerHTML = processedContent;
                
                // Add home glow when we reach the first paragraph
                if (paragraphIndex === 0 && charIndex === currentParagraph.length - 1) {
                    this.createHomeGlow();
                }
                // Add pin float when we reach the Paraná paragraph
                if (paragraphIndex === 1 && charIndex === currentParagraph.length - 1) {
                    this.createPinFloat();
                }
            } else if (chapterNumber === 5) {
                // For Chapter 5, we need to handle HTML content
                const processedContent = this.processChapter5Content(currentParagraph.slice(0, charIndex + 1));
                currentP.innerHTML = processedContent;
                
                // Add golden glow when we reach the first paragraph
                if (paragraphIndex === 0 && charIndex === currentParagraph.length - 1) {
                    this.createGoldenGlow();
                }
            } else if (chapterNumber === 6) {
                // For Chapter 6, we need to handle HTML content
                const processedContent = this.processChapter6Content(currentParagraph.slice(0, charIndex + 1));
                currentP.innerHTML = processedContent;
                
                // Add intimate atmosphere when we reach the first paragraph
                if (paragraphIndex === 0 && charIndex === currentParagraph.length - 1) {
                    this.createIntimateAtmosphere();
                }
            } else if (chapterNumber === 7) {
                // For Chapter 7, we need to handle HTML content
                const processedContent = this.processChapter7Content(currentParagraph.slice(0, charIndex + 1));
                currentP.innerHTML = processedContent;
                
                // Add heart confetti when we reach the last paragraph
                if (paragraphIndex === paragraphs.length - 1 && charIndex === currentParagraph.length - 1) {
                    this.createHeartConfetti();
                }
            } else {
                currentP.textContent = currentParagraph.slice(0, charIndex + 1);
            }
            
            charIndex++;

            if (charIndex >= currentParagraph.length) {
                paragraphIndex++;
                charIndex = 0;
                this.typewriterTimeout = setTimeout(typeNextChar, 75); // Slightly longer pause for dramatic effect (reduced from 300)
            } else {
                this.typewriterTimeout = setTimeout(typeNextChar, 9); // 4x faster (reduced from 35)
            }
        };

        typeNextChar();
    }

    processChapter1Content(text) {
        // Process special formatting for Chapter 1
        return text
            // Handle italics (thoughts)
            .replace(/\*(.*?)\*/g, '<em>$1</em>')
            // Handle bold emphasis
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            // Handle passion words
            .replace(/PASIÓN/g, '<span class="passion-word">PASIÓN</span>')
            // Handle surprise words
            .replace(/NOS OFICIALIZAMOS COMO PAREJA/g, '<span class="surprise-word">NOS OFICIALIZAMOS COMO PAREJA</span>')
            // Handle perfect words
            .replace(/perfecto/g, '<span class="perfect-word">perfecto</span>')
            // Handle affectionate phrases
            .replace(/me atrapó/g, '<span class="affection">me atrapó</span>')
            .replace(/me encantaba/g, '<span class="affection">me encantaba</span>')
            // Make certain emojis larger
            .replace(/🔥/g, '<span class="huge-emoji">🔥</span>')
            .replace(/💍/g, '<span class="huge-emoji">💍</span>')
            .replace(/💖/g, '<span class="large-emoji">💖</span>')
            .replace(/😍/g, '<span class="large-emoji">😍</span>')
            .replace(/🥰/g, '<span class="large-emoji">🥰</span>');
    }

    processChapter2Content(text) {
        // Process special formatting for Chapter 2 (storm theme)
        return text
            // Handle italics (thoughts)
            .replace(/\*(.*?)\*/g, '<em>$1</em>')
            // Handle bold emphasis
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            // Handle storm words with fade effect
            .replace(/tormenta/g, '<span class="storm-word">tormenta</span>')
            // Handle refuge words
            .replace(/refugio/g, '<span class="refuge-word">refugio</span>')
            // Handle promise with pulse
            .replace(/Me prometí no abandonarte en tu momento más difícil/g, '<span class="promise-pulse">Me prometí no abandonarte en tu momento más difícil</span>')
            // Handle hope words with blue tone
            .replace(/💙/g, '<span class="hope-blue">💙</span>')
            .replace(/🌈/g, '<span class="hope-blue">🌈</span>')
            // Make storm emojis dramatic
            .replace(/🌧️/g, '<span class="storm-emoji">🌧️</span>')
            .replace(/⚡/g, '<span class="storm-emoji">⚡</span>')
            .replace(/💔/g, '<span class="storm-emoji">💔</span>');
    }

    processChapter3Content(text) {
        // Process special formatting for Chapter 3 (sunrise/growth theme)
        return text
            // Handle italics (thoughts)
            .replace(/\*(.*?)\*/g, '<em>$1</em>')
            // Handle bold emphasis
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            // Handle connection words with wavy underline
            .replace(/juntos/g, '<span class="underline-wavy pulse-soft">juntos</span>')
            .replace(/conectándonos/g, '<span class="underline-wavy">conectándonos</span>')
            .replace(/nos elegíamos/g, '<span class="underline-wavy">nos elegíamos</span>')
            // Handle heat shimmer effect
            .replace(/MUCHÍSIMO CALOR/g, '<span class="heat-shimmer">MUCHÍSIMO CALOR</span>')
            // Make growth emojis larger and special
            .replace(/🌞/g, '<span class="large-emoji">🌞</span>')
            .replace(/✨/g, '<span class="large-emoji">✨</span>')
            .replace(/🎂/g, '<span class="large-emoji">🎂</span>')
            .replace(/🎉/g, '<span class="large-emoji">🎉</span>')
            .replace(/💞/g, '<span class="large-emoji">💞</span>')
            .replace(/💫/g, '<span class="large-emoji">💫</span>')
            .replace(/🥵/g, '<span class="large-emoji">🥵</span>')
            .replace(/🪭/g, '<span class="large-emoji">🪭</span>');
    }

    processChapter4Content(text) {
        // Process special formatting for Chapter 4 (home/refuge theme)
        return text
            // Handle italics (thoughts)
            .replace(/\*(.*?)\*/g, '<em>$1</em>')
            // Handle bold emphasis
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            // Handle connection words with wavy underline and pulse
            .replace(/juntos/g, '<span class="underline-wavy pulse-soft">juntos</span>')
            .replace(/funcionamos/g, '<span class="underline-wavy pulse-soft">funcionamos</span>')
            // Add pin float to Paraná
            .replace(/📍Paraná/g, '<span class="pin-float">📍</span>Paraná')
            // Style key home/cozy words
            .replace(/refugio/g, '<span class="home-glow">refugio</span>')
            .replace(/casa/g, '<span class="home-glow">casa</span>')
            // Add chip styling to activities
            .replace(/mates compartidos 🧉/g, '<span class="chip">🧉 mates compartidos</span>')
            .replace(/caminatas cortas al atardecer 🚶‍♂️🚶‍♀️/g, '<span class="chip">🚶‍♂️🚶‍♀️ caminatas</span>')
            .replace(/pizzas 🍕/g, '<span class="chip">🍕 pizzas</span>')
            .replace(/helado 🍨/g, '<span class="chip">🍨 helado</span>')
            .replace(/hamburguesas 🍔/g, '<span class="chip">🍔 hamburguesas</span>')
            // Make cozy emojis larger
            .replace(/🏡/g, '<span class="large-emoji">🏡</span>')
            .replace(/💞/g, '<span class="large-emoji">💞</span>')
            .replace(/✨/g, '<span class="large-emoji">✨</span>');
    }

    processChapter5Content(text) {
        // Process special formatting for Chapter 5 (pride and admiration theme)
        return text
            // Handle italics (thoughts)
            .replace(/\*(.*?)\*/g, '<em>$1</em>')
            // Handle bold emphasis
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            // Handle rise-soft animation for "despegar"
            .replace(/despegar/g, '<span class="rise-soft">despegar</span>')
            // Handle fan badge
            .replace(/fan número uno/g, 'fan número uno')
            // Handle gold glow for admiration
            .replace(/admiración/g, '<span class="gold-glow">admiración</span>')
            // Make achievement emojis larger
            .replace(/🌟/g, '<span class="large-emoji">🌟</span>')
            .replace(/🏅/g, '<span class="large-emoji">🏅</span>')
            .replace(/💖/g, '<span class="large-emoji">💖</span>')
            .replace(/✨/g, '<span class="large-emoji">✨</span>');
    }

    processChapter6Content(text) {
        // Process special formatting for Chapter 6 (present/intimate theme)
        return text
            // Handle italics (thoughts)
            .replace(/\*(.*?)\*/g, '<em>$1</em>')
            // Handle bold emphasis
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            // Handle ink-script for love declarations
            .replace(/te amo muchísimo/g, '<span class="heart-beat-once ink-script">te amo muchísimo</span>')
            // Handle breath effect for intimate phrases
            .replace(/Nuestra casa es donde estamos juntos/g, '<span class="breath ink-script">Nuestra casa es donde estamos juntos</span>')
            // Make intimate emojis larger
            .replace(/💞/g, '<span class="large-emoji">💞</span>')
            .replace(/😂/g, '<span class="large-emoji">😂</span>')
            .replace(/🤫/g, '<span class="large-emoji">🤫</span>')
            .replace(/🔥/g, '<span class="large-emoji">🔥</span>');
    }

    processChapter7Content(text) {
        // Process special formatting for Chapter 7 (future/hope theme)
        return text
            // Handle italics (thoughts)
            .replace(/\*(.*?)\*/g, '<em>$1</em>')
            // Handle bold emphasis
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            // Handle shine-soft for future phrases
            .replace(/sé que lo que viene será más grande, más lindo y más nuestro/g, '<span class="shine-soft">sé que lo que viene será más grande, más lindo y más nuestro</span>')
            // Make hope emojis larger
            .replace(/🍫/g, '<span class="large-emoji">🍫</span>')
            .replace(/🐥/g, '<span class="large-emoji">🐥</span>')
            .replace(/✨/g, '<span class="large-emoji">✨</span>')
            .replace(/🏡/g, '<span class="large-emoji">🏡</span>')
            .replace(/✈️/g, '<span class="large-emoji">✈️</span>')
            .replace(/💖/g, '<span class="large-emoji">💖</span>')
            .replace(/🌹/g, '<span class="large-emoji">🌹</span>');
    }

    createBirthdayConfetti() {
        // Check for reduced motion preference
        if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
            return;
        }

        const container = document.getElementById('hearts-container');
        const confettiCount = 15;
        const colors = ['#ff6b9d', '#d4879c', '#e6a8bb', '#f2c8d4', '#ffd700', '#ff8c00'];
        
        for (let i = 0; i < confettiCount; i++) {
            setTimeout(() => {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.textContent = Math.random() > 0.5 ? '🎉' : '🎂';
                
                // Random position and color
                confetti.style.left = `${Math.random() * 100}%`;
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = `${Math.random() * 0.5}s`;
                confetti.style.animationDuration = `${2 + Math.random()}s`;
                
                container.appendChild(confetti);
                
                // Remove after animation
                setTimeout(() => {
                    if (confetti.parentNode) {
                        confetti.parentNode.removeChild(confetti);
                    }
                }, 3000);
            }, i * 50);
        }
    }

    createHomeGlow() {
        // Check for reduced motion preference
        if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
            return;
        }

        const mainContent = document.getElementById('main-content');
        mainContent.classList.add('home-glow');
        
        // Remove the glow class after animation
        setTimeout(() => {
            mainContent.classList.remove('home-glow');
        }, 450);
    }

    createPinFloat() {
        // Check for reduced motion preference
        if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
            return;
        }

        // Find all pin elements and trigger float animation
        const pins = document.querySelectorAll('.pin-float');
        pins.forEach(pin => {
            pin.classList.add('animate');
            
            // Remove animation class after it completes
            setTimeout(() => {
                pin.classList.remove('animate');
            }, 1200);
        });
    }

    createGoldenGlow() {
        // Check for reduced motion preference
        if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
            return;
        }

        const mainContent = document.getElementById('main-content');
        mainContent.classList.add('golden-glow');
        
        // Remove the glow class after animation
        setTimeout(() => {
            mainContent.classList.remove('golden-glow');
        }, 500);
    }

    createIntimateAtmosphere() {
        // Check for reduced motion preference
        if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
            return;
        }

        const mainContent = document.getElementById('main-content');
        mainContent.classList.add('intimate-atmosphere');
        
        // Remove the atmosphere class after animation
        setTimeout(() => {
            mainContent.classList.remove('intimate-atmosphere');
        }, 600);
    }

    createHeartConfetti() {
        // Check for reduced motion preference
        if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
            return;
        }

        const container = document.getElementById('hearts-container');
        const confettiCount = 16;
        const heartTypes = ['❤️', '💕', '💖', '💞', '💝'];
        
        for (let i = 0; i < confettiCount; i++) {
            setTimeout(() => {
                const heart = document.createElement('div');
                heart.className = 'heart-confetti';
                heart.textContent = heartTypes[Math.floor(Math.random() * heartTypes.length)];
                
                // Random position
                heart.style.left = `${Math.random() * 100}%`;
                heart.style.top = `${Math.random() * 20}%`;
                
                // Random animation properties
                heart.style.animationDelay = `${Math.random() * 0.5}s`;
                heart.style.animationDuration = `${2 + Math.random() * 2}s`;
                
                container.appendChild(heart);
                
                // Remove after animation
                setTimeout(() => {
                    if (heart.parentNode) {
                        heart.parentNode.removeChild(heart);
                    }
                }, 4000);
            }, i * 100);
        }
    }

    createRainDrops() {
        // Check for reduced motion preference
        if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
            return;
        }

        const container = document.getElementById('hearts-container');
        const dropCount = 12; // Increased count for better visual effect
        const dropVariations = ['💧', '🌧️', '💙']; // Multiple drop types
        
        // Create multiple waves of raindrops for continuous effect
        for (let wave = 0; wave < 3; wave++) {
            setTimeout(() => {
                for (let i = 0; i < dropCount; i++) {
                    setTimeout(() => {
                        const drop = document.createElement('div');
                        drop.className = 'raindrop';
                        
                        // Vary the drop type
                        drop.textContent = dropVariations[Math.floor(Math.random() * dropVariations.length)];
                        
                        // Better distributed horizontal positioning
                        drop.style.left = `${(i * (100 / dropCount)) + (Math.random() * (100 / dropCount))}%`;
                        
                        // More controlled timing
                        const baseDuration = 3;
                        const durationVariation = Math.random() * 1.5; // 0 to 1.5 seconds variation
                        drop.style.animationDuration = `${baseDuration + durationVariation}s`;
                        
                        // Staggered start times within each wave
                        drop.style.animationDelay = `${Math.random() * 0.8}s`;
                        
                        // Slight size variation
                        const sizeVariation = 0.8 + (Math.random() * 0.4); // 0.8x to 1.2x
                        drop.style.fontSize = `${1.2 * sizeVariation}rem`;
                        
                        container.appendChild(drop);
                        
                        // Remove after animation completes
                        setTimeout(() => {
                            if (drop.parentNode) {
                                drop.parentNode.removeChild(drop);
                            }
                        }, (baseDuration + durationVariation + 1) * 1000);
                    }, i * 150); // Stagger each drop by 150ms
                }
            }, wave * 1000); // Each wave starts 1 second apart
        }
    }

    skipTypewriter() {
        if (!this.isTypewriting) return;
        
        clearTimeout(this.typewriterTimeout);
        this.isTypewriting = false;
        this.hideTypewriterControls();
        
        const chapter = CHAPTERS.find(c => c.id === this.currentChapter);
        const contentEl = document.getElementById('chapter-content');
        
        // Clear the content completely before rendering
        contentEl.innerHTML = '';
        
        const paragraphs = chapter.body.split('\n').filter(p => p.trim());
        
        this.instantRender(contentEl, paragraphs, this.currentChapter);
    }

    showTypewriterControls() {
        document.getElementById('typewriter-controls').style.display = 'flex';
    }

    hideTypewriterControls() {
        document.getElementById('typewriter-controls').style.display = 'none';
    }

    // ===== PROGRESS MANAGEMENT =====
    updateProgress() {
        // Update text
        document.getElementById('progress-text').textContent = `Capítulo ${this.currentChapter} de 7`;
        
        // Update progress bar
        const percentage = (this.currentChapter / 7) * 100;
        document.getElementById('progress-fill').style.width = `${percentage}%`;
        
        // Update dots
        document.querySelectorAll('.progress-dot').forEach((dot, index) => {
            const chapterNum = index + 1;
            dot.classList.remove('active', 'completed');
            dot.removeAttribute('aria-current');
            
            if (chapterNum === this.currentChapter) {
                dot.classList.add('active');
                dot.setAttribute('aria-current', 'true');
            } else if (chapterNum < this.currentChapter) {
                dot.classList.add('completed');
            }
        });
    }

    resetProgress() {
        if (confirm('¿Estás segura de que querés reiniciar la historia desde el principio?')) {
            this.currentChapter = 1;
            this.renderChapter(1);
            this.updateProgress();
            this.saveState();
        }
    }

    // ===== THEME MANAGEMENT =====
    initTheme() {
        const savedTheme = this.settings.theme;
        
        if (savedTheme === 'dark') {
            document.body.setAttribute('data-theme', 'dark');
            this.updateThemeToggle(true);
        } else if (savedTheme === 'light') {
            document.body.removeAttribute('data-theme');
            this.updateThemeToggle(false);
        } else {
            // Auto mode - follow system preference
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (prefersDark) {
                document.body.setAttribute('data-theme', 'dark');
            }
            this.updateThemeToggle(prefersDark);
        }
    }

    toggleTheme() {
        const isDark = document.body.hasAttribute('data-theme');
        
        if (isDark) {
            document.body.removeAttribute('data-theme');
            this.settings.theme = 'light';
            this.updateThemeToggle(false);
        } else {
            document.body.setAttribute('data-theme', 'dark');
            this.settings.theme = 'dark';
            this.updateThemeToggle(true);
        }
        
        this.saveState();
    }

    updateThemeToggle(isDark) {
        const themeBtn = document.getElementById('theme-toggle');
        const modalToggle = document.getElementById('theme-modal-toggle');
        
        themeBtn.textContent = isDark ? '☀️' : '🌙';
        themeBtn.setAttribute('aria-label', isDark ? 'Cambiar a tema claro' : 'Cambiar a tema oscuro');
        
        if (isDark) {
            modalToggle.classList.add('active');
        } else {
            modalToggle.classList.remove('active');
        }
    }

    // ===== SETTINGS MANAGEMENT =====
    openSettings() {
        const modal = document.getElementById('settings-modal');
        modal.classList.add('active');
        modal.setAttribute('aria-hidden', 'false');
        
        // Update toggles
        document.getElementById('typewriter-toggle').classList.toggle('active', this.settings.typewriterEnabled);
        document.getElementById('sound-toggle').classList.toggle('active', this.settings.soundEnabled);
        
        // Focus the close button
        document.getElementById('close-modal').focus();
    }

    closeSettings() {
        const modal = document.getElementById('settings-modal');
        modal.classList.remove('active');
        modal.setAttribute('aria-hidden', 'true');
        
        // Return focus to settings button
        document.getElementById('settings-btn').focus();
    }

    toggleTypewriter() {
        this.settings.typewriterEnabled = !this.settings.typewriterEnabled;
        document.getElementById('typewriter-toggle').classList.toggle('active', this.settings.typewriterEnabled);
        this.saveState();
    }

    toggleSound() {
        this.settings.soundEnabled = !this.settings.soundEnabled;
        document.getElementById('sound-toggle').classList.toggle('active', this.settings.soundEnabled);
        this.saveState();
    }

    // ===== AUDIO MANAGEMENT =====
    initAudio() {
        try {
            this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
        } catch (error) {
            console.warn('Web Audio API not supported');
        }
    }

    playSound() {
        if (!this.settings.soundEnabled || !this.audioContext) return;
        
        try {
            const oscillator = this.audioContext.createOscillator();
            const gainNode = this.audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(this.audioContext.destination);
            
            oscillator.frequency.setValueAtTime(800, this.audioContext.currentTime);
            oscillator.frequency.exponentialRampToValueAtTime(400, this.audioContext.currentTime + 0.1);
            
            gainNode.gain.setValueAtTime(0.1, this.audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.1);
            
            oscillator.start(this.audioContext.currentTime);
            oscillator.stop(this.audioContext.currentTime + 0.1);
        } catch (error) {
            console.warn('Could not play sound:', error);
        }
    }

    // ===== HEARTS ANIMATION =====
    spawnHearts(x, y) {
        const container = document.getElementById('hearts-container');
        const heartCount = 12;
        
        for (let i = 0; i < heartCount; i++) {
            setTimeout(() => {
                this.createHeart(x, y, container);
            }, i * 100);
        }
    }

    spawnHeartsRandom() {
        const container = document.getElementById('hearts-container');
        const heartCount = 6;
        
        for (let i = 0; i < heartCount; i++) {
            setTimeout(() => {
                const x = Math.random() * window.innerWidth;
                const y = window.innerHeight - 100;
                this.createHeart(x, y, container);
            }, i * 150);
        }
    }

    createHeart(x, y, container) {
        // Check for reduced motion preference
        if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
            return;
        }

        let heart;
        
        // Reuse heart from pool or create new one
        if (this.heartPool.length > 0) {
            heart = this.heartPool.pop();
        } else {
            heart = document.createElement('div');
            heart.className = 'heart';
            heart.textContent = '❤️';
        }

        // Position the heart
        heart.style.left = `${x - 12}px`;
        heart.style.top = `${y - 12}px`;
        heart.style.animation = 'none';
        
        container.appendChild(heart);
        
        // Trigger animation
        requestAnimationFrame(() => {
            heart.style.animation = 'floatUp 3s ease-out forwards';
        });

        // Return to pool after animation
        setTimeout(() => {
            if (heart.parentNode) {
                heart.parentNode.removeChild(heart);
                this.heartPool.push(heart);
            }
        }, 3000);
    }

    // ===== UTILITY FUNCTIONS =====
    exportToPDF() {
        window.print();
    }

    openSurprise() {
        // Placeholder function - will be replaced with actual link
        console.log('Opening surprise... (placeholder function)');
        alert('¡Tu sorpresa está esperándote! 🎁\n(Esta función será conectada a tu sorpresa real)');
        
        // Trigger hearts celebration
        for (let i = 0; i < 5; i++) {
            setTimeout(() => {
                this.spawnHeartsRandom();
            }, i * 300);
        }
    }
}

// ===== APPLICATION INITIALIZATION =====
document.addEventListener('DOMContentLoaded', () => {
    window.loveStoryApp = new LoveStoryApp();
});

// ===== GLOBAL FUNCTIONS FOR EXTERNAL ACCESS =====
function openSurprise() {
    if (window.loveStoryApp) {
        window.loveStoryApp.openSurprise();
    }
}

// Export app for external access
window.openSurprise = openSurprise;
